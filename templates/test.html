<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poster Generator</title>
    <!-- 1. Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Vue 3 for reactivity -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* Simple transition for a smoother UI */
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">
    <div id="app" class="w-full max-w-2xl">
        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-slate-800">Poster Generator</h1>
                <p class="text-slate-500 mt-2">Create professional M-PESA posters in seconds.</p>
            </header>

            <!-- Step 1: Template Selection -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-slate-700 border-b-2 border-slate-200 pb-2 mb-4">Step 1: Choose a Template</h2>
                <div v-if="templates.length > 0" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div v-for="template in templates" :key="template.id" @click="selectTemplate(template)"
                        class="cursor-pointer rounded-lg p-4 border-2 transition-all duration-300"
                        :class="selectedTemplate && selectedTemplate.id === template.id ? 'border-blue-500 bg-blue-50 shadow-md' : 'border-slate-300 hover:border-blue-400 hover:bg-slate-50'">
                        <img :src="template.thumbnail || 'https://placehold.co/400x300/e2e8f0/64748b?text=' + template.name" alt="Template Thumbnail" class="rounded-md mb-2 w-full h-24 object-cover">
                        <h3 class="font-semibold text-slate-800 text-center">{{ template.name }}</h3>
                    </div>
                </div>
                <div v-else class="text-center text-slate-500 p-4 border-2 border-dashed rounded-lg">
                    <span v-if="error">{{ error }}</span>
                    <span v-else>Loading templates...</span>
                </div>
            </div>

            <!-- Step 2: Dynamic Form Generation -->
            <transition name="fade">
                <div v-if="selectedTemplate" class="mb-6">
                    <h2 class="text-xl font-semibold text-slate-700 border-b-2 border-slate-200 pb-2 mb-4">Step 2: Fill in the Details</h2>
                    <form @submit.prevent="generatePoster" class="space-y-4">
                        <!-- Common Field: Business Name -->
                        <div>
                            <label class="block font-medium text-slate-600 mb-1">Business Name</label>
                            <input v-model="formData.business_name" type="text" required
                                class="w-full px-4 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                        </div>
                        
                        <!-- Dynamically Generated Fields -->
                        <div v-for="field in selectedTemplate.required_fields" :key="field.name">
                            <label :for="field.name" class="block font-medium text-slate-600 mb-1">{{ field.label }}</label>
                            <input :id="field.name" v-model="formData.data[field.name]" :type="field.type" required
                                class="w-full px-4 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                        </div>

                        <!-- Submit Button with Loading State -->
                        <button type="submit" :disabled="isLoading"
                            class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all duration-300 disabled:bg-slate-400 disabled:cursor-not-allowed flex items-center justify-center">
                            <svg v-if="isLoading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>{{ isLoading ? 'Generating...' : 'Generate Poster' }}</span>
                        </button>
                    </form>
                </div>
            </transition>
            
            <!-- Step 3: Result Display -->
            <transition name="fade">
                <div v-if="pdfUrl || (error && !isLoading)" class="mt-8 text-center">
                    <!-- Success Message -->
                    <div v-if="pdfUrl" class="bg-green-100 border-l-4 border-green-500 text-green-800 p-4 rounded-md">
                        <h3 class="font-bold text-lg mb-2">Poster Generated Successfully!</h3>
                        <a :href="pdfUrl" target="_blank"
                            class="inline-block bg-green-600 text-white font-bold py-2 px-6 rounded-md hover:bg-green-700 transition-transform hover:scale-105">
                            Download PDF
                        </a>
                    </div>
                    <!-- Error Message -->
                    <div v-if="error && !isLoading" class="bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-md">
                        <h3 class="font-bold">An Error Occurred</h3>
                        <p>{{ error }}</p>
                    </div>
                </div>
            </transition>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                // --- STATE ---
                // --- FIX #1: Updated the port to 8081 ---
                const API_BASE_URL = 'http://localhost:8081/api'; 

                const templates = ref([]);
                const selectedTemplate = ref(null);
                const formData = ref({
                    business_name: '',
                    data: {}
                });
                const isLoading = ref(false);
                const error = ref('');
                const pdfUrl = ref('');

                // --- METHODS ---
                const fetchTemplates = async () => {
                    error.value = ''; // Clear previous errors
                    try {
                        const response = await fetch(`${API_BASE_URL}/posters/templates`);
                        if (!response.ok) throw new Error('Failed to fetch templates from server.');
                        
                        const responsePayload = await response.json();
                        
                        const templatesArray = responsePayload.listdatapayload.data;

                        if (!Array.isArray(templatesArray)) {
                            throw new Error('API response for templates is not in a valid format.');
                        }

                        templates.value = templatesArray.map(t => {
                            if (t && typeof t.required_fields === 'string' && t.required_fields) {
                                try {
                                    t.required_fields = JSON.parse(t.required_fields);
                                } catch (e) {
                                    console.error("Failed to parse required_fields for template:", t.name, e);
                                    t.required_fields = [];
                                }
                            } else {
                                t.required_fields = [];
                            }
                            return t;
                        });

                    } catch (e) {
                        console.error(e);
                        error.value = 'Could not load templates. Make sure your backend is running and CORS is enabled.';
                    }
                };
                
                const selectTemplate = (template) => {
                    selectedTemplate.value = template;
                    formData.value = { business_name: '', data: {} };
                    pdfUrl.value = '';
                    error.value = '';
                };

                const generatePoster = async () => {
                    if (!selectedTemplate.value) return;

                    isLoading.value = true;
                    error.value = '';
                    pdfUrl.value = '';
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/posters/generate?template_id=${selectedTemplate.value.id}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formData.value),
                        });

                        const result = await response.json();
                        if (!response.ok) throw new Error(result.message || 'An unknown error occurred.');
                        
                        // --- FIX #2: Updated the path to the PDF URL to match the Postman response ---
                        const generatedUrl = result.datapayload?.data?.pdf_url;
                        
                        if (!generatedUrl) {
                            throw new Error('PDF URL not found in the server response.');
                        }

                        // The PDF URL from the backend is relative, so we need to prepend the base URL
                        pdfUrl.value = `http://localhost:8081/${generatedUrl}`;

                    } catch (e) {
                        console.error(e);
                        error.value = e.message;
                    } finally {
                        isLoading.value = false;
                    }
                };

                // --- LIFECYCLE HOOKS ---
                onMounted(() => {
                    fetchTemplates();
                });

                // --- RETURN VALUES ---
                return {
                    templates,
                    selectedTemplate,
                    formData,
                    isLoading,
                    error,
                    pdfUrl,
                    selectTemplate,
                    generatePoster,
                };
            }
        }).mount('#app');
    </script>
</body>
</html>

